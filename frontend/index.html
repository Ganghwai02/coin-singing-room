<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PRACTICE MODE - 슈퍼 노래방</title>
    <style>
        :root { --neon-blue: #00d4ff; --neon-pink: #ff00ff; --dark-bg: #050505; }
        body { background: var(--dark-bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* 상단바 */
        .top-bar { display: flex; justify-content: space-between; padding: 15px 40px; background: rgba(0,0,0,0.8); z-index: 10; border-bottom: 1px solid #333; }
        .info-pill { background: rgba(255,255,255,0.1); padding: 5px 20px; border-radius: 20px; border: 1px solid var(--neon-blue); font-size: 14px; }

        /* 비디오 & 가사 영역 */
        .screen { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        #player { position: absolute; width: 100%; height: 100%; pointer-events: none; } /* 유튜브 플레이어 */
        
        .lyrics-overlay {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            background: rgba(0,0,0,0.5); padding: 20px 0; z-index: 5;
        }
        .lyric-text { font-size: 3rem; font-weight: bold; text-shadow: 2px 2px 10px #000; color: #fff; }

        /* 하단 컨트롤 바 */
        .control-bar { background: #111; padding: 20px; display: flex; justify-content: center; gap: 15px; z-index: 10; }
        button { padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-play { background: var(--neon-blue); color: #000; }
        .btn-score { background: var(--neon-pink); color: #fff; }
        .btn-cancel { background: #444; color: #fff; }

        /* 예약 팝업 (임시) */
        .reservation { position: absolute; top: 80px; left: 20px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 1px solid #444; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="info-pill">남은 횟수: <span id="remainCount">3</span>회</div>
        <div id="statusTitle" style="color: var(--neon-blue); font-weight: bold;">대기 중...</div>
        <div class="info-pill" id="roomTag">Room_A</div>
    </div>

    <div class="screen">
        <div id="player"></div>
        
        <div class="lyrics-overlay">
            <div class="lyric-text" id="lyricCurrent">예약을 시작해 주세요</div>
        </div>
    </div>

    <div class="control-bar">
        <button class="btn-play" onclick="playNext()">다음 곡 시작 (Dequeue)</button>
        <button class="btn-score" onclick="submitScore(100)">점수 제출 (100점 테스트)</button>
        <button class="btn-cancel" onclick="location.reload()">새로고침</button>
    </div>

    <div class="reservation">
        <input type="number" id="songIdInput" placeholder="곡ID" style="width: 50px; padding: 5px;">
        <button onclick="enqueue()" style="padding: 5px 10px;">예약</button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const API_BASE = "http://127.0.0.1:8000/api/songs";
        let player;
        let currentSongId = null;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: 'dQw4w9WgXcQ', // 초기 영상 (Rick Astley)
                playerVars: { 'autoplay': 0, 'controls': 0, 'showinfo': 0, 'rel': 0 },
                events: { 'onReady': onPlayerReady }
            });
        }

        function onPlayerReady(event) { console.log("Player Ready"); }

        async function enqueue() {
            const sid = document.getElementById('songIdInput').value;
            await fetch(`${API_BASE}/${sid}/enqueue`, {method:'POST'});
            alert("예약 완료!");
        }

        async function playNext() {
            const res = await fetch(`${API_BASE}/queue/play-next`, {method:'POST'});
            if(!res.ok) return alert("대기열이 비었습니다.");
            const data = await res.json();
            
            currentSongId = data.song_id;
            document.getElementById('statusTitle').innerText = "재생 중: " + data.title;
            document.getElementById('remainCount').innerText = data.remaining_plays;

            // 유튜브 영상 교체 및 재생
            if(data.video_url) {
                const videoId = data.video_url.split('v=')[1];
                player.loadVideoById(videoId);
            }
            
            startLyrics(data.song_id);
        }

        async function startLyrics(sid) {
            const res = await fetch(`${API_BASE}/${sid}/lyrics`);
            const data = await res.json();
            let time = 0;
            const timer = setInterval(() => {
                time++;
                const sync = data.sync_data.find(s => s.time === time);
                if(sync) {
                    document.getElementById('lyricCurrent').innerText = sync.text;
                    document.getElementById('lyricCurrent').style.color = (time % 2 === 0) ? "var(--neon-blue)" : "#fff";
                }
                if(time > 20) {
                    clearInterval(timer);
                    document.getElementById('lyricCurrent').innerText = "연주가 끝났습니다.";
                    player.stopVideo();
                }
            }, 1000);
        }

        async function submitScore(score) {
            if(!currentSongId) return alert("곡을 먼저 재생하세요.");
            const res = await fetch(`${API_BASE}/finish`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({song_id: currentSongId, score: score})
            });
            const data = await res.json();
            alert(data.message);
            document.getElementById('remainCount').innerText = data.remaining_plays;
        }
    </script>
</body>
</html>