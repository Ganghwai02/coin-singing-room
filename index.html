<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PRACTICE MODE - 슈퍼 노래방</title>
    <style>
        :root { --neon-blue: #00d4ff; --neon-pink: #ff00ff; --dark-bg: #0a0b10; }
        body { background: var(--dark-bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { display: flex; justify-content: space-between; padding: 15px 40px; background: rgba(255,255,255,0.05); }
        .info-pill { background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 20px; border: 1px solid var(--neon-blue); font-size: 14px; }
        .main-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .lyrics-container { width: 100%; text-align: left; padding-left: 10%; margin-top: 20px; }
        .lyric-text { font-size: 32px; font-weight: bold; color: white; text-shadow: 0 0 10px var(--neon-blue); }
        .pitch-bar { width: 80%; height: 10px; background: #333; margin-top: 30px; border-radius: 5px; }
        .control-bar { background: rgba(0,0,0,0.9); padding: 20px; display: flex; justify-content: center; gap: 10px; }
        button { padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--neon-blue); color: black; }
        .btn-sub { background: #444; color: white; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="info-pill">남은 횟수: <span id="remainCount">3</span>회</div>
        <div class="info-pill" id="currentRoomTag">Room_A</div>
        <div style="color: var(--neon-blue);">PRACTICE MODE</div>
    </div>

    <div class="main-display">
        <div style="width:70%; height:40%; border:2px solid #333; display:flex; align-items:center; justify-content:center; border-radius:20px;">
            <h1 id="displayTitle">곡을 예약해 주세요</h1>
        </div>
        <div class="lyrics-container">
            <div class="lyric-text" id="lyricCurrent">READY</div>
        </div>
        <div class="pitch-bar"><div id="pitchProgress" style="width:0%; height:100%; background:var(--neon-pink); transition: 0.5s;"></div></div>
    </div>

    <div class="control-bar">
        <button class="btn-main" onclick="playNext()">다음 곡 재생</button>
        <button class="btn-sub" onclick="submitScore(100)">100점 테스트(보너스)</button>
        <button class="btn-sub" onclick="getLeaderboard()">랭킹 보기</button>
        <input type="number" id="songIdInput" placeholder="ID" style="width:50px;">
        <button class="btn-main" onclick="enqueue()">예약</button>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000/api/songs";
        let currentSongId = null;

        async function enqueue() {
            const sid = document.getElementById('songIdInput').value;
            await fetch(`${API_BASE}/${sid}/enqueue`, {method:'POST'});
            alert("예약되었습니다!");
        }

        async function playNext() {
            const res = await fetch(`${API_BASE}/queue/play-next`, {method:'POST'});
            if(!res.ok) return alert("대기열이 비었습니다.");
            const data = await res.json();
            currentSongId = data.song_id;
            document.getElementById('displayTitle').innerText = data.title;
            document.getElementById('remainCount').innerText = data.remaining_plays;
            loadLyrics(data.song_id);
        }

        async function loadLyrics(sid) {
            const res = await fetch(`${API_BASE}/${sid}/lyrics`);
            const data = await res.json();
            let time = 0;
            const timer = setInterval(() => {
                time++;
                const sync = data.sync_data.find(s => s.time === time);
                if(sync) document.getElementById('lyricCurrent').innerText = sync.text;
                document.getElementById('pitchProgress').style.width = (time*5) + "%";
                if(time > 20) clearInterval(timer);
            }, 1000);
        }

        async function submitScore(score) {
            if(!currentSongId) return alert("재생 중인 곡이 없습니다.");
            const res = await fetch(`${API_BASE}/finish`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({song_id: currentSongId, score: score})
            });
            const data = await res.json();
            alert(data.message);
            document.getElementById('remainCount').innerText = data.remaining_plays;
        }

        async function getLeaderboard() {
            const res = await fetch(`${API_BASE}/social/leaderboard`);
            const data = await res.json();
            alert("TOP 1: " + data[0].username + " (" + data[0].top_score + "점)");
        }
    </script>
</body>
</html>